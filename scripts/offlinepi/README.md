# offlinepi

Utilities for managing an offline version of PyPI.

## Installation

Installation requires `mitmproxy`. We require unreleased changes, it is recommended to install from GitHub:

```
pip install git+https://github.com/mitmproxy/mitmproxy@1fcd0335d59c301d73d1b1ef676ecafcf520ab79
```

## Usage

Record PyPI responses during a command:

```
./offlinepi record <command>
```

Replay PyPI responses during a command:

```
./offlinepi replay <command>
```

### Example

Record server interactions during Puffin's tests:

```
./offlinepi record cargo test --features pypi -- --test-threads=1
```

**Note**: Recording tests without parallelism is helpful for reliable replays.

Then, run it again using replayed responses:

```
./offlinepi replay cargo test --features pypi
```

## TLS Certificates

In order to record HTTPS requests, the certificate generated by mitmproxy must be installed.
See [the mitmproxy certificate documentation](https://docs.mitmproxy.org/stable/concepts-certificates/) for details.

## Implementation

[mitmproxy](https://mitmproxy.org/) is used to record and replay responses.

The proxy is temporarily created for the execution of the provided command.

The command _must_ respect the `HTTP_PROXY` and `HTTPS_PROXY` environment variables.

Response recording is limited to `pypi.org` and `files.pythonhosted.org`.

Responses are written to `responses.dat` in the `offlinepi` project root.
